<!DOCTYPE html>
<html>
<head>
    <title>Ezinbea Sokoban</title>
    <style>
        canvas { border: 2px solid #333; background: #eee; }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="352" height="416"></canvas>
    <p>矢印キーで操作 / Rでリセット</p>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const SIZE = 32;

        // 0:床, 1:壁, 2:荷物, 3:ゴール, 4:荷物inゴール
        let map = [
            [0, 0, 0, 1 ,1 ,1 ,1 ,1 ,0 ,0 ,0],
            [0, 0, 0, 1 ,3 ,3 ,3 ,1 ,0 ,0 ,0],
            [0, 0, 0, 1 ,0 ,0 ,0 ,1 ,0 ,0 ,0],
            [0, 0, 0, 1 ,0 ,0 ,0 ,1 ,0 ,0 ,0],
            [1, 1, 1, 1 ,1 ,0 ,1 ,1 ,1 ,1 ,1],
            [1, 0, 0, 0 ,0 ,0 ,1 ,0 ,0 ,1 ,1],
            [1, 0, 1, 2 ,0 ,2 ,0 ,2 ,0 ,1 ,1],
            [1, 0, 0, 0 ,1 ,1 ,1 ,0 ,0 ,1 ,1],
            [1, 1, 1, 0 ,1 ,0 ,1 ,0 ,1 ,1 ,1],
            [0, 0, 1, 0 ,1 ,0 ,1 ,0 ,1 ,0 ,0],
            [0, 0, 1, 0 ,0 ,0 ,0 ,0 ,1 ,0 ,0],
            [0, 0, 1, 0 ,0 ,0 ,0 ,0 ,1 ,0 ,0],
            [0, 0, 1, 1 ,1 ,0 ,1 ,1 ,1 ,0 ,0]
        ];
        let player = { x: 5, y: 8 };

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            map.forEach((row, y) => {
                row.forEach((cell, x) => {
                    if (cell === 1) ctx.fillStyle = "#333"; // 壁
                    else if (cell === 2) ctx.fillStyle = "#8b4513"; // 荷物
                    else if (cell === 3) ctx.fillStyle = "#ff69b4"; // ゴール
                    else if (cell === 4) ctx.fillStyle = "#32cd32"; // 荷物(済)
                    else ctx.fillStyle = "#fff"; // 床
                    ctx.fillRect(x * SIZE, y * SIZE, SIZE - 1, SIZE - 1);
                });
            });
            // プレイヤー描画
            ctx.fillStyle = "#0000ff";
            ctx.fillRect(player.x * SIZE + 4, player.y * SIZE + 4, SIZE - 9, SIZE - 9);
        }
        function checkClear() {
            // 全ての行、全ての列をチェック
            const isAllCleared = map.every(row => 
                // 2（ゴールに乗っていない荷物）が一つもなければクリア
                row.every(cell => cell !== 2)
            );

            if (isAllCleared) {
                // 少し遅らせてメッセージを出す（描画を優先するため）
                setTimeout(() => {
                    alert("おお　しんじられぬ！　パズルを　とくとは！\nかわきのつぼを　さずけよう！");
                }, 100);
            }
        }
        function move(dx, dy) {
            let nx = player.x + dx, ny = player.y + dy;
            let target = map[ny][nx];

            if (target === 0 || target === 3) { // 歩ける
                player.x = nx; player.y = ny;
            } else if (target === 2 || target === 4) { // 荷物
                let nnx = nx + dx, nny = ny + dy;
                if (map[nny][nnx] === 0 || map[nny][nnx] === 3) {
                    map[ny][nx] = (target === 2) ? 0 : 3;
                    map[nny][nnx] = (map[nny][nnx] === 0) ? 2 : 4;
                    player.x = nx; player.y = ny;
                }
            }
            checkClear();
            draw();
        }

        window.addEventListener("keydown", e => {
            if (e.key === "ArrowUp") move(0, -1);
            if (e.key === "ArrowDown") move(0, 1);
            if (e.key === "ArrowLeft") move(-1, 0);
            if (e.key === "ArrowRight") move(1, 0);
            if (e.key === "r") location.reload(); // Rでリセット
        });

        draw();
    </script>
</body>
</html>